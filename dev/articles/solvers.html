<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Custom solvers and tool calling • vitals</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Custom solvers and tool calling">
<meta name="robots" content="noindex">
<script defer data-domain="vitals.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vitals</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/vitals.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/analysis.html">Analyzing evaluation results</a></li>
    <li><a class="dropdown-item" href="../articles/solvers.html">Custom solvers and tool calling</a></li>
    <li><a class="dropdown-item" href="../articles/writing-evals.html">Writing evals for your LLM product</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/vitals/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Custom solvers and tool calling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/vitals/blob/main/vignettes/articles/solvers.Rmd" class="external-link"><code>vignettes/articles/solvers.Rmd</code></a></small>
      <div class="d-none name"><code>solvers.Rmd</code></div>
    </div>

    
    
<p>In the “Getting started with vitals” vignette, we introduced
evaluation <code>Task</code>s with a basic analysis on “An R Eval.”
Using the built-in solver <code><a href="../reference/generate.html">generate()</a></code>, we passed inputs to
models and treated their raw responses as the final result. vitals
supports supplying arbitrary functions as solvers, though. In this
example, we’ll use a custom solver to explore the following
question:</p>
<blockquote>
<p>Does equipping models with the ability to peruse package
documentation make them better at writing R code?</p>
</blockquote>
<p>We’ll briefly reintroduce the <code>are</code> dataset, define the
custom solver, and then see whether Claude does any better on the
<code>are</code> Task using the custom solver compared to plain
<code><a href="../reference/generate.html">generate()</a></code>.</p>
<p>First, loading the required packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/vitals" class="external-link">vitals</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellmer.tidyverse.org" class="external-link">ellmer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/posit-dev/btw" class="external-link">btw</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="an-r-eval-dataset">An R eval dataset<a class="anchor" aria-label="anchor" href="#an-r-eval-dataset"></a>
</h2>
<p>From the <code>are</code> docs:</p>
<blockquote>
<p>An R Eval is a dataset of challenging R coding problems. Each
<code>input</code> is a question about R code which could be solved on
first-read only by human experts and, with a chance to read
documentation and run some code, by fluent data scientists. Solutions
are in <code>target</code> and enable a fluent data scientist to
evaluate whether the solution deserves full, partial, or no credit.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">are</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Rows: 29</span></span>
<span><span class="co">#&gt; Columns: 7</span></span>
<span><span class="co">#&gt; $ id        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "after-stat-bar-heights"<span style="color: #949494;">, </span>"conditional-grouped-summ…</span></span>
<span><span class="co">#&gt; $ input     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "This bar chart shows the count of different cuts o…</span></span>
<span><span class="co">#&gt; $ target    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Preferably: \n\n```\nggplot(data = diamonds) + \n …</span></span>
<span><span class="co">#&gt; $ domain    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Data analysis"<span style="color: #949494;">, </span>"Data analysis"<span style="color: #949494;">, </span>"Data analysis"<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ task      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "New code"<span style="color: #949494;">, </span>"New code"<span style="color: #949494;">, </span>"New code"<span style="color: #949494;">, </span>"Debugging"<span style="color: #949494;">, </span>"N…</span></span>
<span><span class="co">#&gt; $ source    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "https://jrnold.github.io/r4ds-exercise-solutions/d…</span></span>
<span><span class="co">#&gt; $ knowledge <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> "tidyverse"<span style="color: #949494;">, </span>"tidyverse"<span style="color: #949494;">, </span>"tidyverse"<span style="color: #949494;">, </span>"r-lib"<span style="color: #949494;">, </span>"t…</span></span></code></pre>
<p>At a high level:</p>
<ul>
<li>
<code>id</code>: A unique identifier for the problem.</li>
<li>
<code>input</code>: The question to be answered.</li>
<li>
<code>target</code>: The solution, often with a description of
notable features of a correct solution.</li>
<li>
<code>domain</code>, <code>task</code>, and <code>knowledge</code>
are pieces of metadata describing the kind of R coding challenge.</li>
<li>
<code>source</code>: Where the problem came from, as a URL. Many of
these coding problems are adapted “from the wild” and include the kinds
of context usually available to those answering questions.</li>
</ul>
<p>In the introductory vignette, we just provided the
<code>input</code>s as-is to an ellmer chat’s <code>$chat()</code>
method (via the built-in <code><a href="../reference/generate.html">generate()</a></code> solver). In this
vignette, we’ll compare those results to an approach resulting from
first giving the models a chance to read relevant R package
documentation.</p>
</div>
<div class="section level2">
<h2 id="custom-solvers">Custom solvers<a class="anchor" aria-label="anchor" href="#custom-solvers"></a>
</h2>
<p>To help us better understand how solvers work, lets look at the
implementation of <code><a href="../reference/generate.html">generate()</a></code>. <code><a href="../reference/generate.html">generate()</a></code> is a
function factory, meaning that the function itself outputs a
function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sonnet_3_7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_anthropic.html" class="external-link">chat_anthropic</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"claude-3-7-sonnet-latest"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/generate.html">generate</a></span><span class="op">(</span>solver_chat <span class="op">=</span> <span class="va">sonnet_3_7</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; function (inputs, ..., solver_chat = chat) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     check_inherits(solver_chat, "Chat")</span></span>
<span><span class="co">#&gt;     ch &lt;- solver_chat$clone()</span></span>
<span><span class="co">#&gt;     res &lt;- ellmer::parallel_chat(ch, as.list(inputs), ...)</span></span>
<span><span class="co">#&gt;     list(result = purrr::map_chr(res, function(c) c$last_turn()@text), </span></span>
<span><span class="co">#&gt;         solver_chat = res)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55789bf202c0&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55789bf1f1e8&gt;</span></span></code></pre></div>
<p>While, in documentation, I’ve mostly written “<code><a href="../reference/generate.html">generate()</a></code>
just calls <code>$chat()</code>,” there are a couple extra tricks up
<code><a href="../reference/generate.html">generate()</a></code>’s sleeves:</p>
<ol style="list-style-type: decimal">
<li>The chat is first cloned with <code>$clone()</code> so that the
original chat object isn’t modified once vitals calls it.</li>
<li>Rather than <code>$chat()</code>, <code><a href="../reference/generate.html">generate()</a></code> calls
<code><a href="https://ellmer.tidyverse.org/reference/parallel_chat.html" class="external-link">ellmer::parallel_chat()</a></code>. This is why
<code><a href="../reference/generate.html">generate()</a></code> takes <code>inputs</code>–e.g. the whole
<code>input</code> column–rather than a single <code>input</code>.
<code><a href="https://ellmer.tidyverse.org/reference/parallel_chat.html" class="external-link">parallel_chat()</a></code> will send off all of the requests in
parallel (not in the usual R sense of multiple R processes, but in the
sense of asychronous HTTP requests), greatly reducing the amount of time
it takes to run evaluations.</li>
</ol>
<p>The function that <code>generate</code> outputs takes in a list of
<code>inputs</code> and outputs a list with two elements:</p>
<ul>
<li>
<code>result</code> is the final result from the solver. In this
case, <code>purrr::map_chr(res, function(c) c$last_turn()@text)</code>
just grabs the text from the last assistant run and returns it.
<code>result</code> is a vector of length equal to
<code>inputs</code>—it should be able to be tacked onto
<code>task$get_samples()</code> as another column.</li>
<li>
<code>solver_chat</code> is a list of chats that led to the
<code>result</code>. This may seem redundant with <code>result</code>,
but is important to supply to vitals so that the package can log what
happened during the solving process and display it in the log
viewer.</li>
</ul>
<p>We will work with a slightly modified version of
<code><a href="../reference/generate.html">generate()</a></code> that equips models with the ability to peruse R
package documentation before answering. We will do so using the btw
package, available on GitHub at <a href="https://posit-dev.github.io/btw/" class="external-link uri">https://posit-dev.github.io/btw/</a>. Among other things,
btw provides a function <code><a href="https://posit-dev.github.io/btw/reference/btw_tools.html" class="external-link">btw_tools()</a></code> that returns a list of
tools that can be registered with an ellmer chat.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ch</span> <span class="op">&lt;-</span> <span class="va">sonnet_3_7</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ch</span><span class="op">$</span><span class="fu">set_tools</span><span class="op">(</span><span class="fu"><a href="https://posit-dev.github.io/btw/reference/btw_tools.html" class="external-link">btw_tools</a></span><span class="op">(</span>tools <span class="op">=</span> <span class="st">"docs"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>✔ Registered tool btw_tool_docs_package_help_topics
✔ Registered tool btw_tool_docs_help_page
✔ Registered tool btw_tool_docs_available_vignettes
✔ Registered tool btw_tool_docs_vignette</code></pre>
<p>I can use the chat’s <code>$chat()</code> method to interact with it
like before. As an example, after registering btw with a Claude Sonnet
3.7 chat object, I can ask it about this package, vitals. At the time of
writing, vitals is not on CRAN, and Claude Sonnet 3.7 completed training
several months before I started working on it. Nonetheless, the model is
able to tell me about how custom solvers work:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ch</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"How do custom solvers work in vitals?"</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>I’ll help you find information about custom solvers in the vitals
package. Let me first check if the vitals package is installed and then
explore its documentation.</p>
<p><snip>The models lets us know it’s reading a bunch of
documentation.&lt;&gt;</snip></p>
<p>To create a custom solver, you need to:</p>
<ol style="list-style-type: decimal">
<li>Define a function that:
<ul>
<li>Takes a vector of inputs as its first argument</li>
<li>Returns a list with two elements:
<ul>
<li>
<code>result</code>: A vector of final responses (same length as
input)</li>
<li>
<code>solver_chat</code>: The list of ellmer chat objects used (same
length as input)</li>
</ul>
</li>
</ul>
</li>
<li>Your custom solver can include additional logic to:
<ul>
<li>Preprocess inputs before sending to the LLM</li>
<li>Post-process model responses</li>
<li>Implement special handling like multi-turn conversations</li>
<li>Incorporate tools or external knowledge</li>
<li>Add retry mechanisms or fallbacks</li>
</ul>
</li>
</ol>
<p><snip> Yada yada yada. </snip></p>
</blockquote>
<p>Pretty spot-on. But will this capability help the models better
answer questions in R? <code>are</code> is built from questions about
base R and popular packages like dplyr and shiny, information about
which is presumably baked into their weights.</p>
<p>The implementation of our custom solver looks almost exactly like
<code><a href="../reference/generate.html">generate()</a></code>s implementation, except we add a call to
<code><a href="https://posit-dev.github.io/btw/reference/btw_tools.html" class="external-link">btw_tools()</a></code> before calling
<code><a href="https://ellmer.tidyverse.org/reference/parallel_chat.html" class="external-link">ellmer::parallel_chat()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">btw_solver</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">...</span>, <span class="va">solver_chat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ch</span> <span class="op">&lt;-</span> <span class="va">solver_chat</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">ch</span><span class="op">$</span><span class="fu">set_tools</span><span class="op">(</span><span class="fu"><a href="https://posit-dev.github.io/btw/reference/btw_tools.html" class="external-link">btw_tools</a></span><span class="op">(</span>tools <span class="op">=</span> <span class="st">"docs"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">ellmer</span><span class="fu">::</span><span class="fu"><a href="https://ellmer.tidyverse.org/reference/parallel_chat.html" class="external-link">parallel_chat</a></span><span class="op">(</span><span class="va">ch</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    result <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">res</span>, <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="va">c</span><span class="op">$</span><span class="fu">last_turn</span><span class="op">(</span><span class="op">)</span><span class="op">@</span><span class="va">text</span><span class="op">)</span>, </span>
<span>    solver_chat <span class="op">=</span> <span class="va">res</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This solver is ready to situate in a Task and get solving!</p>
</div>
<div class="section level2">
<h2 id="running-the-solver">Running the solver<a class="anchor" aria-label="anchor" href="#running-the-solver"></a>
</h2>
<p>Situate a custom solver in a dataset in the same way you would with a
built-in one:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">are_btw</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Task.html">Task</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="va">are</span>,</span>
<span>  solver <span class="op">=</span> <span class="va">btw_solver</span>,</span>
<span>  scorer <span class="op">=</span> <span class="fu"><a href="../reference/scorer_model.html">model_graded_qa</a></span><span class="op">(</span>partial_credit <span class="op">=</span> <span class="cn">TRUE</span>, scorer_chat <span class="op">=</span> <span class="va">sonnet_3_7</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"An R Eval"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">are_btw</span></span></code></pre></div>
<p>As in the introductory vignette, we supply the <code>are</code>
dataset and the built-in scorer <code><a href="../reference/scorer_model.html">model_graded_qa()</a></code>. Then, we
use <code>$eval()</code> to evaluate our custom solver, evaluate the
scorer, and then explore a persistent log of the results in the
interactive Inspect log viewer.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">are_btw</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span>solver_chat <span class="op">=</span> <span class="va">sonnet_3_7</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Any arguments to solving or scoring functions can be passed directly
to <code>$eval()</code>, allowing for quickly evaluating tasks across
several parameterizations. We’ll just use Claude Sonnet 3.7 for now.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">are_btw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vitals_bind.html">vitals_bind</a></span><span class="op">(</span><span class="va">are_btw</span><span class="op">)</span></span>
<span></span>
<span><span class="va">are_btw_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 29 × 4</span></span></span>
<span><span class="co">#&gt;    task    id                          score metadata         </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> are_btw after-stat-bar-heights      I     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> are_btw conditional-grouped-summary C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> are_btw correlated-delays-reasoning P     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> are_btw curl-http-get               P     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> are_btw dropped-level-legend        I     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> are_btw filter-multiple-conditions  C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> are_btw geocode-req-perform         C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> are_btw group-by-summarize-message  C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> are_btw grouped-filter-summarize    P     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> are_btw grouped-geom-line           C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 19 more rows</span></span></span></code></pre></div>
<p>Claude answered fully correctly in 15 out of 29 samples, and
partially correctly 8 times. Using the metadata, we can also determine
how often the model looked at at least one help-page before supplying an
answer:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat_called_a_tool</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">chat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">turns</span> <span class="op">&lt;-</span> <span class="va">chat</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">get_turns</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_lgl</a></span><span class="op">(</span><span class="va">turns</span>, <span class="va">turn_called_a_tool</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">turn_called_a_tool</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">turn</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_lgl</a></span><span class="op">(</span><span class="va">turn</span><span class="op">@</span><span class="va">contents</span>, <span class="va">inherits</span>, <span class="st">"ellmer::ContentToolRequest"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">are_btw_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html" class="external-link">hoist</a></span><span class="op">(</span><span class="va">metadata</span>, <span class="st">"solver_chat"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>called_a_tool <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_lgl</a></span><span class="op">(</span><span class="va">solver_chat</span>, <span class="va">chat_called_a_tool</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">called_a_tool</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; FALSE  TRUE </span></span>
<span><span class="co">#&gt;     3    26</span></span></code></pre></div>
<p>When equipped with the ability to peruse documentation, the model
almost always made use of it. To see the kinds of docs it decided to
look at, click in a few samples in the log viewer for this eval:</p>
<iframe src="../example-logs/solvers/index.html" width="100%" height="600px" style="border-radius: 10px; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);"></iframe>
<p><br></p>
<p>Did perusing documentation actually help the model write better R
code, though? In order to quantify “better,” we need to also run this
evaluation <em>without</em> the model being able to access
documentation.</p>
<p>Using the same code from the introductory vignette:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">are_basic</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Task.html">Task</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="va">are</span>,</span>
<span>  solver <span class="op">=</span> <span class="fu"><a href="../reference/generate.html">generate</a></span><span class="op">(</span>solver_chat <span class="op">=</span> <span class="va">sonnet_3_7</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  scorer <span class="op">=</span> <span class="fu"><a href="../reference/scorer_model.html">model_graded_qa</a></span><span class="op">(</span>partial_credit <span class="op">=</span> <span class="cn">TRUE</span>, scorer_chat <span class="op">=</span> <span class="va">sonnet_3_7</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"An R Eval"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">are_basic</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>(Note that we also could have used <code>are_btw$set_solver()</code>
here if we didn’t want to recreate the task.)</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">are_eval_data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="co"># the argument names will become the entries in `task`</span></span>
<span>  <span class="fu"><a href="../reference/vitals_bind.html">vitals_bind</a></span><span class="op">(</span>btw <span class="op">=</span> <span class="va">are_btw</span>, basic <span class="op">=</span> <span class="va">are_basic</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># and, in this case, different tasks correspond to different solvers</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>solver <span class="op">=</span> <span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="va">are_eval_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 58 × 4</span></span></span>
<span><span class="co">#&gt;    solver id                          score metadata         </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> btw    after-stat-bar-heights      I     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> btw    conditional-grouped-summary C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> btw    correlated-delays-reasoning P     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> btw    curl-http-get               P     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> btw    dropped-level-legend        I     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> btw    filter-multiple-conditions  C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> btw    geocode-req-perform         C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> btw    group-by-summarize-message  C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> btw    grouped-filter-summarize    P     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> btw    grouped-geom-line           C     <span style="color: #949494;">&lt;tibble [1 × 10]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 48 more rows</span></span></span></code></pre></div>
<p>Is this difference in performance just a result of noise, though? We
can supply the scores to an ordinal regression model to answer this
question.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/runehaubo/ordinal" class="external-link">ordinal</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'ordinal'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     slice</span></span>
<span></span>
<span><span class="va">are_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ordinal/man/clm.html" class="external-link">clm</a></span><span class="op">(</span><span class="va">score</span> <span class="op">~</span> <span class="va">solver</span>, data <span class="op">=</span> <span class="va">are_eval_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">are_mod</span></span>
<span><span class="co">#&gt; formula: score ~ solver</span></span>
<span><span class="co">#&gt; data:    are_eval_data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  link  threshold nobs logLik AIC    niter max.grad cond.H </span></span>
<span><span class="co">#&gt;  logit flexible  58   -60.19 126.38 4(0)  1.25e-09 1.2e+01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; solverbtw </span></span>
<span><span class="co">#&gt;    0.2159 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Threshold coefficients:</span></span>
<span><span class="co">#&gt;     I|P     P|C </span></span>
<span><span class="co">#&gt; -1.0381  0.1101</span></span></code></pre></div>
<p>The coefficient for <code>solver == "btw"</code> is 0.216, indicating
that allowing the model to peruse documentation tends to be associated
with higher grades. If a 95% confidence interval for this coefficient
contains zero, we can conclude that there is not sufficient evidence to
reject the null hypothesis that the difference between GPT-4o and
Claude’s performance on this eval is zero at the 0.05 significance
level.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">are_mod</span><span class="op">)</span></span>
<span><span class="co">#&gt;                2.5 %   97.5 %</span></span>
<span><span class="co">#&gt; solverbtw -0.7572417 1.196237</span></span></code></pre></div>
<div class="callout-note">
<p>If we had evaluated this model across multiple epochs, the question
ID could become a “nuisance parameter” in a mixed model, e.g. with the
model structure
<code>ordinal::clmm(score ~ model + (1|id), ...)</code>.</p>
</div>
<p>This article demonstrated using a custom solver by modifying the
built-in <code><a href="../reference/generate.html">generate()</a></code> to allow models to make tool calls that
peruse package documentation. With vitals, tool calling “just works”;
calls to any tool registered with ellmer will automatically be
incorporated into evaluation logs.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Simon Couch, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
